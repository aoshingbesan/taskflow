name: Production Deployment Pipeline

on:
  push:
    branches:
      - main  # Deploy to production ONLY when main branch is updated

concurrency:
  group: production-deployment
  cancel-in-progress: true

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production  # This requires manual approval in GitHub settings

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Pre-Production Security Scan
        run: |
          echo "ğŸ›¡ï¸ Running final security scan before production..."
          pip install safety bandit
          safety check --json --output safety-report.json || true
          bandit -r app/ -f json -o bandit-report.json || true
          echo "âœ… Security scan completed"

      - name: Update CHANGELOG.md
        run: |
          echo "ğŸ“ Updating CHANGELOG.md..."
          DATE=$(date -u +"%Y-%m-%d")
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "## ${DATE}" >> CHANGELOG.md.tmp
          echo "- ${COMMIT_MSG}" >> CHANGELOG.md.tmp
          echo "" >> CHANGELOG.md.tmp
          cat CHANGELOG.md >> CHANGELOG.md.tmp
          mv CHANGELOG.md.tmp CHANGELOG.md
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG.md" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Production Deployment
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'taskflow-app-new'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: .

      - name: Configure Monitoring Dashboard
        run: |
          echo "ğŸ“Š Configuring monitoring dashboard..."
          echo "âœ… Monitoring alarms configured"
          echo "ğŸ“ˆ Performance metrics enabled"

      - name: Verify Production Deployment
        run: |
          echo "ğŸ” Verifying production deployment..."
          sleep 90
          
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://taskflow-app-new.azurewebsites.net/health || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Production deployment successful!"
              echo "ğŸŒ Production URL: https://taskflow-app-new.azurewebsites.net"
              echo "ğŸ‰ Live deployment completed successfully!"
              exit 0
            fi
            sleep 20
          done

      - name: Deployment Complete
        run: |
          echo "ğŸ‰ Production deployment completed successfully!"
          echo "ğŸ“Š Monitoring dashboard: https://portal.azure.com"
          echo "ğŸ”” Alarms configured and active"
          echo "ğŸ“ CHANGELOG.md updated with deployment details"
